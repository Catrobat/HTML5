'use strict';PocketCode.merge({_InitialPopStateController:(function(){function _InitialPopStateController(){this.historyLength=history.length;this.objClassName='_InitialPopStateController'}Object.defineProperties(_InitialPopStateController.prototype,{hasOpenDialogs:{value:false,},});_InitialPopStateController.prototype.dispose=function(){delete this.historyLength;delete this.objClassName;this._disposed=true};return _InitialPopStateController})(),HistoryEntry:(function(){function HistoryEntry(a,b,c,d,e){this.historyIdx=a;this.globalDialogsLength=b;this.page={};if(typeof c==='string')this.page.id=c;else if(typeof c==='object'&&c.objClassName)this.page.id=c.objClassName;else throw new Error('invalid arguemnt page: expected classname as string or an object supporting an accessor \'objClassName\'');this.page.viewState=d;this.page.dialogsLength=e||0}return HistoryEntry})(),Player:{Application:(function(){Application.extends(SmartJs.Components.Application,false);function Application(a,b,c){var d=new PocketCode.Ui.Viewport();d.hide();this._dialogs=[];SmartJs.Components.Application.call(this,d);this._mobileInitialized=c;this._noPromtOnLeave=false;this._forwardNavigationAllowed=false;this._loadingError=false;if(!d.rendered)d.addToDom(a||document.body);this._vp=d;this._onInit=new SmartJs.Event.Event(this);this._onMobileInitRequired=new SmartJs.Event.Event(this);this._onHWRatioChange=new SmartJs.Event.Event(this);this._onExit=new SmartJs.Event.Event(this);this._onError.addEventListener(new SmartJs.Event.EventListener(this._globalErrorHandler,this));PocketCode.I18nProvider.onError.addEventListener(new SmartJs.Event.EventListener(this._i18nControllerErrorHandler,this));PocketCode.I18nProvider.onDirectionChange.addEventListener(new SmartJs.Event.EventListener(function(e){this._vp.uiDirection=e.direction},this));if(!c||b&&PocketCode.I18nProvider.currentLanguage!=b){PocketCode.I18nProvider.init(b)}else{if(PocketCode.I18nProvider.currentLanguageDirection===PocketCode.Ui.Direction.RTL)PocketCode.I18nProvider.onDirectionChange.dispatchEvent({direction:PocketCode.Ui.Direction.RTL})}if(SmartJs.Device.isMobile&&!c){var f=history.state;if(f!==null&&f.historyIdx>0)history.go(-f.historyIdx);return}this._pages={_InitialPopStateController:new PocketCode._InitialPopStateController(),PlayerPageController:new PocketCode.PlayerPageController(),};this._project=new PocketCode.GameEngine();this._project.onLoadingError.addEventListener(new SmartJs.Event.EventListener(this._projectLoadingErrorHandler,this));this._project.onLoad.addEventListener(new SmartJs.Event.EventListener(this._projectLoadHandler,this));this._currentProjectId=undefined;this._isMobilePage=a?false:true;if(SmartJs.Device.isMobile){var g;if(history.state!==null)g=history.state.historyIdx;if(g===undefined||g===0){this._currentHistoryIdx=0;history.replaceState(new PocketCode.HistoryEntry(this._currentHistoryIdx,this._dialogs.length,this._pages._InitialPopStateController),document.title,'');this._pages._InitialPopStateController.historyLength=history.length}this._popstateListener=this._addDomListener(window,'popstate',this._popstateHandler)}else{this._escKeyListener=this._addDomListener(document,'keyup',function(e){if(e.keyCode==27)this._escKeyHandler(e)})}}Object.defineProperties(Application.prototype,{hasOpenDialogs:{get:function(){return this._dialogs.length>0||this._currentPage.hasOpenDialogs}},});Object.defineProperties(Application.prototype,{onInit:{get:function(){return this._onInit}},onMobileInitRequired:{get:function(){return this._onMobileInitRequired}},onHWRatioChange:{get:function(){return this._onHWRatioChange}},onExit:{get:function(){return this._onExit}},onUiDirectionChange:{get:function(){return PocketCode.I18nProvider.onDirectionChange}},});Application.prototype.merge({_globalErrorHandler:function(e){var a=e.error,msg=a.message,file=a.file||a.filename||a.fileName,line=a.lineno,column=a.colno,stack='';if(a.error.stack)stack=a.error.stack;try{this._project.stopProject()}catch(e){}if(this._currentPage)this._currentPage.actionOnGlobalError();var d=new PocketCode.Ui.GlobalErrorDialog();d.onOK.addEventListener(new SmartJs.Event.EventListener(this._onExit.dispatchEvent,this._onExit));this._onInit.dispatchEvent();this._showDialog(d,false);PocketCode.LoggingProvider.sendMessage(a,this._currentProjectId);this._project.dispose()},_i18nControllerErrorHandler:function(e){PocketCode.I18nProvider.onError.removeEventListener(new SmartJs.Event.EventListener(this._i18nControllerErrorHandler,this));throw new Error('i18nControllerError: '+e.responseText);},_projectLoadHandler:function(e){if(!this._loadingError&&!e.loadingAlerts){this._pages.PlayerPageController.enableView();return}if(this._loadingError){var d=new PocketCode.Ui.ProjectLoadingErrorDialog();d.onCancel.addEventListener(new SmartJs.Event.EventListener(this._onExit.dispatchEvent,this._onExit));d.onRetry.addEventListener(new SmartJs.Event.EventListener(function(e){e.target.dispose();this._loadingError=false;this._project.reloadProject()},this));this._showDialog(d,false);return}var a=e.loadingAlerts;var b=[],warnings=[];if(a.deviceEmulation)b.push('msgDeviceEmulation');if(a.deviceLockRequired)b.push('msgDeviceLockScreen');if(a.invalidSoundFiles.length!=0)warnings.push('lblUnsupportedSound');if(a.unsupportedBricks.length!=0)warnings.push('lblUnsupportedBricks');warnings=warnings.concat(a.deviceUnsupportedFeatures);var d=new PocketCode.Ui.ProjectLoadingAlertDialog(b,warnings);d.onCancel.addEventListener(new SmartJs.Event.EventListener(this._onExit.dispatchEvent,this._onExit));d.onContinue.addEventListener(new SmartJs.Event.EventListener(function(e){e.target.dispose();this._pages.PlayerPageController.enableView()},this));this._showDialog(d,false)},_projectLoadingErrorHandler:function(e){this._loadingError=e},_requestProjectDetails:function(){var a=new PocketCode.ServiceRequest(PocketCode.Services.PROJECT_DETAILS,SmartJs.RequestMethod.GET,{id:this._currentProjectId,imgDataMax:0});a.onLoad.addEventListener(new SmartJs.Event.EventListener(this._projectDetailsRequestLoadHandler,this));a.onError.addEventListener(new SmartJs.Event.EventListener(this._projectDetailsRequestErrorHandler,this));PocketCode.Proxy.send(a)},_projectDetailsRequestLoadHandler:function(e){if(this._disposing||this._disposed)return;var a=e.target.responseJson;if(SmartJs.Device.isMobile)this._onInit.dispatchEvent();else this._onInit.dispatchEvent({menu:this._pages.PlayerPageController.menu});this._pages.PlayerPageController.projectDetails=a;this._viewport.show();this._requestProject()},_projectDetailsRequestErrorHandler:function(e){if(this._disposing||this._disposed)return;var d,type;var a=e.statusCode,errorJson=e.responseJson;if(a)type=errorJson.type||'InternalServerError';else type='ServerConnectionError';switch(type){case'ProjectNotFoundException':d=new PocketCode.Ui.ProjectNotFoundDialog();break;case'ServerConnectionError':d=new PocketCode.Ui.ServerConnectionErrorDialog();d.onCancel.addEventListener(new SmartJs.Event.EventListener(this._onExit.dispatchEvent,this._onExit));d.onRetry.addEventListener(new SmartJs.Event.EventListener(function(e){e.target.dispose();this._requestProjectDetails()},this));break;default:d=new PocketCode.Ui.InternalServerErrorDialog()}if(d.onOK)d.onOK.addEventListener(new SmartJs.Event.EventListener(this._onExit.dispatchEvent,this._onExit));this._onInit.dispatchEvent();this._showDialog(d,false)},_requestProject:function(){var a=new PocketCode.ServiceRequest(PocketCode.Services.PROJECT,SmartJs.RequestMethod.GET,{id:this._currentProjectId});a.onLoad.addEventListener(new SmartJs.Event.EventListener(this._projectRequestLoadHandler,this));a.onError.addEventListener(new SmartJs.Event.EventListener(this._projectRequestErrorHandler,this));PocketCode.Proxy.send(a)},_projectRequestLoadHandler:function(e){if(this._disposing||this._disposed)return;var a=e.target.responseJson;if(a.header&&a.header.device){var b=a.header.device;this._onHWRatioChange.dispatchEvent({ratio:b.screenHeight/b.screenWidth})}this._project.loadProject(a)},_projectRequestErrorHandler:function(e){if(this._disposing||this._disposed)return;var d,type;var a=e.statusCode,errorJson=e.responseJson;if(a)type=errorJson?errorJson.type||'InternalServerError':'InternalServerError';else type='ServerConnectionError';switch(type){case'ProjectNotFoundException':d=new PocketCode.Ui.ProjectNotFoundDialog();break;case'InvalidProjectFileException':d=new PocketCode.Ui.ProjectNotValidDialog();break;case'FileParserException':d=new PocketCode.Ui.ParserErrorDialog();PocketCode.LoggingProvider.sendMessage(errorJson,this._currentProjectId);break;case'ServerConnectionError':d=new PocketCode.Ui.ServerConnectionErrorDialog();d.onCancel.addEventListener(new SmartJs.Event.EventListener(this._onExit.dispatchEvent,this._onExit));d.onRetry.addEventListener(new SmartJs.Event.EventListener(function(e){e.target.dispose();this._requestProject()},this));break;default:d=new PocketCode.Ui.InternalServerErrorDialog();PocketCode.LoggingProvider.sendMessage(errorJson,this._currentProjectId)}if(d.onOK)d.onOK.addEventListener(new SmartJs.Event.EventListener(this._onExit.dispatchEvent,this._onExit));this._onInit.dispatchEvent();this._showDialog(d,false)},_escKeyHandler:function(e){var l=this._dialogs.length;if(l>0){this._dialogs[l-1].execDefaultBtnAction();e.preventDefault();return false}else this._currentPage.execDialogDefaultOnEsc()},_popstateHandler:function(e){var a=e.state;if(a==null)return e.preventDefault();if(!a.page)throw new Error('invalid navigation entry');var b=this._pages[a.page.id];if(this._currentHistoryIdx<a.historyIdx&&!this._forwardNavigationAllowed){history.back();return e.preventDefault()}this._currentHistoryIdx=a.historyIdx;if(b.objClassName==='_InitialPopStateController'){if(b.historyLength>1){if(this._noPromtOnLeave||!this._project.projectLoaded)this._onExit.dispatchEvent();else{var d=new PocketCode.Ui.ExitWarningDialog();d.onExit.addEventListener(new SmartJs.Event.EventListener(this._onExit.dispatchEvent,this._onExit));d.onCancel.addEventListener(new SmartJs.Event.EventListener(function(e){e.target.dispose();this._forwardNavigationAllowed=true;history.forward()},this));this._onInit.dispatchEvent();this._showDialog(d,false)}}else{this._forwardNavigationAllowed=true;history.forward()}return e.preventDefault()}this._forwardNavigationAllowed=false;var c=this._dialogs;for(var i=a.dialogsLength||0,l=c.length-1;i<=l;l--){c[l].dispose();c.pop()}this._showPage(b,a)},_showPage:function(a,b){if(!(a instanceof PocketCode.PageController))throw new Error('invalid argument: page, expectet type: PocketCode.PageController');if(SmartJs.Device.isMobile){if(b){var c=b.page;a.loadViewState(c.viewState,c.dialogsLength)}else{this._currentHistoryIdx++;history.pushState(new PocketCode.HistoryEntry(this._currentHistoryIdx,this._dialogs.length,a),document.title,'')}a.currentHistoryIdx=this._currentHistoryIdx}this._currentPage=a;this._vp.loadPageView(a.view)},_showDialog:function(a,b){if(!(a instanceof PocketCode.Ui.Dialog))throw new Error('invalid argument: dialog');if(SmartJs.Device.isMobile&&b!==false){this._dialogs.push(a);history.pushState(new PocketCode.HistoryEntry(this._currentHistoryIdx,this._dialogs.length,this._currentPage),document.title,'')}this._viewport.addDialog(a);this._viewport.show()},loadProject:function(a){if(this._disposing||this._disposed)return;this._loadingError=false;var b=PocketCode.isPlayerCompatible();var c=b.result;if(!c){if(!b.tests.SmartJs){alert('sorry.. your browser does not meet the HTML5 feature requirements to run this application');this._onExit.dispatchEvent()}else{var d=new PocketCode.Ui.BrowserNotSupportedDialog();d.onOK.addEventListener(new SmartJs.Event.EventListener(this._onExit.dispatchEvent,this._onExit));this._onInit.dispatchEvent();this._showDialog(d,false)}return}if(SmartJs.Device.isMobile&&!this._mobileInitialized){var d=new PocketCode.Ui.MobileRestrictionDialog();d.onCancel.addEventListener(new SmartJs.Event.EventListener(this._onExit.dispatchEvent,this._onExit));d.onConfirm.addEventListener(new SmartJs.Event.EventListener(function(e){this._viewport.hide();this._onMobileInitRequired.dispatchEvent(e)},this));this._onInit.dispatchEvent();this._showDialog(d,false);return}this._showPage(this._pages.PlayerPageController);this._currentPage.project=this._project;this._currentProjectId=a;this._requestProjectDetails()},toggleMuteSounds:function(){this._muted=this._muted?false:true;this._project.muted=this._muted;return this._muted},dispose:function(){this._vp.hide();if(this._popstateListener)this._removeDomListener(window,'popstate',this._popstateListener);if(this._escKeyListener)this._removeDomListener(document,'keyup',this._escKeyListener);if(this._project&&this._project.onLoadingError)this._project.onLoadingError.removeEventListener(new SmartJs.Event.EventListener(this._projectLoadingErrorHandler,this));for(var a in this._pages)this._pages[a].dispose();SmartJs.Components.Application.prototype.dispose.call(this)},});return Application})(),},});