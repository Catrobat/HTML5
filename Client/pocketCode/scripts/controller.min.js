'use strict';PocketCode.BaseController=(function(){BaseController.extends(SmartJs.Core.EventTarget);function BaseController(a){if(!(a instanceof SmartJs.Ui.Control))throw new Error('invalid argument: view: expected instance SmartJs.Ui.Control');this._view=a}Object.defineProperties(BaseController.prototype,{view:{get:function(){return this._view},},});BaseController.prototype.merge({showView:function(){this._view.show()},hideView:function(){this._view.hide()},});return BaseController})();PocketCode.PageController=(function(){PageController.extends(PocketCode.BaseController,false);function PageController(a){if(!(a instanceof PocketCode.Ui.PageView))throw new Error('invalid argument: view: expected type PageView');PocketCode.BaseController.call(this,a);this._currentHistoryIdx=undefined;this._dialogs=[]}Object.defineProperties(PageController.prototype,{currentHistoryIdx:{set:function(a){this._currentHistoryIdx=a},},hasOpenDialogs:{get:function(){return this._dialogs.length>0},},});PageController.prototype.merge({loadViewState:function(a,b){var c=this._dialogs;for(var i=b,l=c.length-1;i<=l;l--){c[l].dispose();c.pop()}},_showDialog:function(a){if(!(a instanceof PocketCode.Ui.Dialog))throw new Error('invalid argument: dialog');this._dialogs.push(a);if(SmartJs.Device.isMobile){var b=history.state;history.pushState(new PocketCode.HistoryEntry(b.historyIdx+1,b.dialogsLength,this,PocketCode.ExecutionState.RUNNING,this._dialogs.length),document.title,'')}this._view.appendChild(a)},execDialogDefaultOnEsc:function(){var l=this._dialogs.length;if(l>0)this._dialogs[l-1].execDefaultBtnAction()},actionOnGlobalError:function(){},});return PageController})();

PocketCode.PlayerPageController=(function(){PlayerPageController.extends(PocketCode.PageController,false);function PlayerPageController(){PocketCode.PageController.call(this,new PocketCode.Ui.PlayerPageView());this._playerViewportController=new PocketCode.PlayerViewportController();this._view.insertAt(0,this._playerViewportController.view);this._axesVisible=false;this._view.onToolbarButtonClicked.addEventListener(new SmartJs.Event.EventListener(this._buttonClickedHandler,this));this._view.onMenuAction.addEventListener(new SmartJs.Event.EventListener(this._menuActionHandler,this));this._view.onMenuOpen.addEventListener(new SmartJs.Event.EventListener(this._pauseProject,this));this._view.onStartClicked.addEventListener(new SmartJs.Event.EventListener(function(e){this._buttonClickedHandler(e.merge({command:PocketCode.Ui.PlayerBtnCommand.START}))},this));this._view.onExitClicked.addEventListener(new SmartJs.Event.EventListener(function(e){this._buttonClickedHandler(e.merge({command:PocketCode.Ui.PlayerBtnCommand.BACK}))},this));this._playerViewportController.onUserAction.addEventListener(new SmartJs.Event.EventListener(this._onUserActionHandler,this));SmartJs.Ui.Window.onVisibilityChange.addEventListener(new SmartJs.Event.EventListener(this._visibilityChangeHandler,this));this._playerViewportController.setProjectScreenSize(200,320);if(!SmartJs.Device.isMobile||history.length==0)this._view.backButtonDisabled=true;this._gameEngine=undefined}Object.defineProperties(PlayerPageController.prototype,{menu:{get:function(){return this._view.menu},},projectDetails:{set:function(a){this._view.showStartScreen(a.title,a.baseUrl+a.thumbnailUrl)},},project:{set:function(a){if(!(a instanceof PocketCode.GameEngine))throw new Error('invalid argumenent: project');if(a===this._gameEngine)return;if(this._gameEngine){this._gameEngine.onLoadingProgress.removeEventListener(new SmartJs.Event.EventListener(this._projectLoadingProgressHandler,this));this._gameEngine.onBeforeProgramStart.removeEventListener(new SmartJs.Event.EventListener(this._beforeProjectStartHandler,this));this._gameEngine.onSceneChange.removeEventListener(new SmartJs.Event.EventListener(this.sceneChangedHandler,this));this._gameEngine.onProgramExecuted.removeEventListener(new SmartJs.Event.EventListener(this._projectExecutedHandler,this));this._gameEngine.onSpriteUiChange.removeEventListener(new SmartJs.Event.EventListener(this._uiUpdateHandler,this));this._gameEngine.onVariableUiChange.removeEventListener(new SmartJs.Event.EventListener(this._varUpdateHandler,this));this._gameEngine.dispose()}this._gameEngine=a;this._gameEngine.onLoadingProgress.addEventListener(new SmartJs.Event.EventListener(this._projectLoadingProgressHandler,this));this._gameEngine.onBeforeProgramStart.addEventListener(new SmartJs.Event.EventListener(this._beforeProjectStartHandler,this));this._gameEngine.onSceneChange.addEventListener(new SmartJs.Event.EventListener(this.sceneChangedHandler,this));this._gameEngine.onProgramExecuted.addEventListener(new SmartJs.Event.EventListener(this._projectExecutedHandler,this));this._gameEngine.onSpriteUiChange.addEventListener(new SmartJs.Event.EventListener(this._uiUpdateHandler,this));this._gameEngine.onVariableUiChange.addEventListener(new SmartJs.Event.EventListener(this._varUpdateHandler,this));this._gameEngine.onCameraUsageChange.addEventListener(new SmartJs.Event.EventListener(this._cameraChangedHandler,this))},},});PlayerPageController.prototype.merge({loadViewState:function(a,b){PocketCode.PageController.prototype.loadViewState.call(this,a,b);if(a===PocketCode.ExecutionState.PAUSED){if(this._gameEngine.executionState==PocketCode.ExecutionState.RUNNING)this._pauseProject()}else{this._gameEngine.stopProject()}this._view.executionState=a},actionOnGlobalError:function(){this._view.disabled=true},_visibilityChangeHandler:function(e){if(e.visible==false)this._pauseProject()},_projectLoadingProgressHandler:function(e){this._view.setLoadingProgress(e.progress)},enableView:function(){this._view.disabled=false},_beforeProjectStartHandler:function(e){if(e.reinit){this._playerViewportController.clearViewport()}this._view.hideStartScreen()},sceneChangedHandler:function(e){var a=e.screenSize;this._playerViewportController.setProjectScreenSize(a.width,a.height);this._playerViewportController.renderingSprites=e.renderingSprites;this._playerViewportController.renderingTexts=e.renderingTexts;this._playerViewportController.initScene(e.id,a,e.reinit)},_projectExecutedHandler:function(e){if(SmartJs.Device.isMobile)return history.back();this._view.executionState=PocketCode.ExecutionState.STOPPED},_uiUpdateHandler:function(e){this._playerViewportController.updateSprite(e.id,e.properties)},_varUpdateHandler:function(e){this._playerViewportController.updateVariable(e.objectId,e.id,e.properties)},_cameraChangedHandler:function(e){this._playerViewportController.updateCameraUse(e.on,e.video,e.width,e.height,e.transparency,e.orientation)},_buttonClickedHandler:function(e){this._view.closeMenu();switch(e.command){case PocketCode.Ui.PlayerBtnCommand.BACK:history.back();break;case PocketCode.Ui.PlayerBtnCommand.RESTART:if(this._screenshotDialog&&!this._screenshotDialog.disposed){this._dialogs.remove(this._screenshotDialog);this._screenshotDialog.dispose()}if(SmartJs.Device.isMobile){var a=history.state;history.replaceState(new PocketCode.HistoryEntry(a.historyIdx,a.dialogsLength,this,PocketCode.ExecutionState.PAUSED,this._dialogs.length),document.title,'');history.pushState(new PocketCode.HistoryEntry(a.historyIdx+1,a.dialogsLength,this,PocketCode.ExecutionState.RUNNING,this._dialogs.length),document.title,'')}this._gameEngine.restartProject();this._view.executionState=PocketCode.ExecutionState.RUNNING;this._view.screenshotButtonDisabled=false;this._view.axesButtonDisabled=false;break;case PocketCode.Ui.PlayerBtnCommand.START:if(this._screenshotDialog&&!this._screenshotDialog.disposed){this._dialogs.remove(this._screenshotDialog);this._screenshotDialog.dispose()}if(SmartJs.Device.isMobile){var a=history.state;history.replaceState(new PocketCode.HistoryEntry(a.historyIdx,a.dialogsLength,this,PocketCode.ExecutionState.PAUSED,this._dialogs.length),document.title,'');history.pushState(new PocketCode.HistoryEntry(a.historyIdx+1,a.dialogsLength,this,PocketCode.ExecutionState.RUNNING,this._dialogs.length),document.title,'')}if(this._view.executionState==PocketCode.ExecutionState.PAUSED)this._gameEngine.resumeProject();else this._gameEngine.runProject();this._view.executionState=PocketCode.ExecutionState.RUNNING;this._view.screenshotButtonDisabled=false;this._view.axesButtonDisabled=false;break;case PocketCode.Ui.PlayerBtnCommand.PAUSE:this._pauseProject();break;case PocketCode.Ui.PlayerBtnCommand.SCREENSHOT:this._pauseProject();var b=this._playerViewportController.takeScreenshot();this._showScreenshotDialog(b);break;case PocketCode.Ui.PlayerBtnCommand.AXES:if(!this._axesVisible){this._playerViewportController.showAxes();this._view.axesButtonChecked=true;this._axesVisible=true}else{this._playerViewportController.hideAxes();this._view.axesButtonChecked=false;this._axesVisible=false}break;default:}},_menuActionHandler:function(e){switch(e.command){case PocketCode.Player.MenuCommand.FULLSCREEN:this._playerViewportController.zoomToFit=e.checked;break;case PocketCode.Player.MenuCommand.LANGUAGE_CHANGE:PocketCode.I18nProvider.loadDictionary(e.languageCode);break;case PocketCode.Player.MenuCommand.TERMS_OF_USE:var a=window.open('https://share.catrob.at/pocketcode/termsOfUse','_blank');if(a)a.focus();break;case PocketCode.Player.MenuCommand.IMPRINT:var a=window.open('http://developer.catrobat.org/imprint','_blank');if(a)a.focus();break;case PocketCode.Player.MenuCommand.HELP:var a=window.open('https://share.catrob.at/pocketcode/help','_blank');if(a)a.focus();break}},_onUserActionHandler:function(e){this._gameEngine.handleUserAction(e)},_pauseProject:function(){if(this._gameEngine&&this._gameEngine.pauseProject())this._view.executionState=PocketCode.ExecutionState.PAUSED},_showScreenshotDialog:function(a){var d=new PocketCode.Ui.ScreenshotDialog();if(this._screenshotDialog&&!this._screenshotDialog.disposed){this._dialogs.remove(this._screenshotDialog);this._screenshotDialog.dispose()}this._screenshotDialog=d;d.onCancel.addEventListener(new SmartJs.Event.EventListener(function(e){this._dialogs.remove(e.target);e.target.dispose();if(SmartJs.Device.isMobile)history.back()},this));if(SmartJs.Device.isMobile){var b=history.state;history.replaceState(new PocketCode.HistoryEntry(b.historyIdx,b.dialogsLength,this,PocketCode.ExecutionState.PAUSED,this._dialogs.length),document.title,'')}else d.onDownload.addEventListener(new SmartJs.Event.EventListener(this._downloadScreenshot,this));d.imageSrc=a;this._showDialog(d)},_downloadScreenshot:function(e){e.target.download()},dispose:function(){SmartJs.Ui.Window.onVisibilityChange.removeEventListener(new SmartJs.Event.EventListener(this._visibilityChangeHandler,this));if(this._gameEngine&&!this._gameEngine._disposing&&!this._gameEngine._disposed){this._gameEngine.onLoadingProgress.removeEventListener(new SmartJs.Event.EventListener(this._projectLoadingProgressHandler,this));this._gameEngine.onBeforeProgramStart.removeEventListener(new SmartJs.Event.EventListener(this._beforeProjectStartHandler,this));this._gameEngine.onProgramExecuted.removeEventListener(new SmartJs.Event.EventListener(this._projectExecutedHandler,this));this._gameEngine.onSpriteUiChange.removeEventListener(new SmartJs.Event.EventListener(this._uiUpdateHandler,this));this._gameEngine.onVariableUiChange.removeEventListener(new SmartJs.Event.EventListener(this._varUpdateHandler,this));this._gameEngine=undefined}this._playerViewportController.onUserAction.removeEventListener(new SmartJs.Event.EventListener(this._onUserActionHandler,this));PocketCode.PageController.prototype.dispose.call(this)},});return PlayerPageController})();

PocketCode.PlayerViewportController=(function(){PlayerViewportController.extends(PocketCode.BaseController,false);function PlayerViewportController(){PocketCode.BaseController.call(this,new PocketCode.Ui.PlayerViewportView());this._renderingSprite=[];this._renderingTexts=[];this._redrawRequired=false;this._redrawInProgress=false;this._projectScreenWidth=200;this._projectScreenHeight=380;this._zoomToFit=false}Object.defineProperties(PlayerViewportController.prototype,{renderingSprites:{set:function(a){if(!(a instanceof Array))throw new Error('invalid argument: rendering images');this._renderingSprite=a;this._view.renderingSprites=a},},renderingTexts:{set:function(a){if(!(a instanceof Array))throw new Error('invalid argument: texts');this._renderingTexts=a;this._view.renderingTexts=a},},dimensions:{get:function(){return{width:this._projectScreenWidth,height:this._projectScreenHeight}},},zoomToFit:{set:function(a){this._zoomToFit=a},},});Object.defineProperties(PlayerViewportController.prototype,{onUserAction:{get:function(){return this._view.onUserAction},},});PlayerViewportController.prototype.merge({updateSprite:function(a,b){var c,imgs=this._renderingSprite,visible;if(b.showAskDialog){this._view.showAskDialog(b.question,b.callback);delete b.showAskDialog;delete b.question;delete b.callback;if(Object.keys(b).length==0)return}else if(b.penX||b.penY){this._view.movePen(a,b.penX,b.penY)}else if(b.drawStamp==true){this._view.drawStamp(a);delete b.drawStamp;if(Object.keys(b).length==0)return}else if(b.clearBackground==true){this._view.clearCurrentPenStampCache();delete b.clearBackground;if(Object.keys(b).length==0)return}for(var i=0,l=imgs.length;i<l;i++){c=imgs[i];if(c.id===a){visible=c.visible;c.merge(b);if(b.layer!==undefined){var d=b.layer;imgs.remove(c);if(d>imgs.length)imgs.push(c);else if(d<1)imgs.insert(1,c);imgs.insert(d,c)}if(c.visible||visible!=c.visible)this._view.render();break}}},updateVariable:function(a,b,c){var d,_texts=this._renderingTexts,_visible;for(var i=0,l=_texts.length;i<l;i++){d=_texts[i];_visible=d.visible;if(d.objectId==a&&d.id===b){d.merge(c);if(d.visible!=false||_visible!=d.visible)this._view.render();break}}},updateCameraUse:function(a,b){this._view.updateCameraUse(a,b)},setProjectScreenSize:function(a,b){this._projectScreenWidth=a;this._projectScreenHeight=b;this._view.setOriginalViewportSize(a,b)},showAxes:function(){this._view.showAxes()},hideAxes:function(){this._view.hideAxes()},initScene:function(a,b,c){this._view.initScene(a,b,c)},clearViewport:function(){this._view.clear()},takeScreenshot:function(){return this._view.getCanvasDataURL()},});return PlayerViewportController})();
